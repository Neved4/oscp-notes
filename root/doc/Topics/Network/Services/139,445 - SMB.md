# Pentesting SMB (139, 445)

# Prerequisites

```bash
apt install cifs-utils python3-poetry
```

```bash
netexec smb $target
netexec smb $target -u guest -p '' --shares
netexec smb $target -u guest -p '' --shares --local-auth
netexec smb $target -u '' -p '' --shares
netexec smb $target -u '' -p '' --shares --local-auth
netexec smb $target -u 'guest' -p '' --shares --spider databases --regex .
```

# Gathering

- [ ] List shared resources
  ```bash
  smbclient -L $ip -N
  ```

- [ ] List resources with `smbmap`
  ```bash
  smbmap -H '127.0.0.1'
  ```

- [ ] Connect to a shared resource
  ```bash
  smbclient //127.0.0.1/myshare -N
  ```

- [ ] Mount shared resource
  ```bash
  mount -t cifs //127.0.0.1/myshare /mnt/mounted \
  	-o username=null,password=null,domain=,rw
  ```

- [ ] Scan the service
  ```bash
  nmap -sCV -p139,445 $ip
  ```

- [ ] Use `crackmapexec`
  ```bash
  poetry run crackmapexec smb 127.0.0.1 --shares
  ```


Mount SMB shared resource for easier navigation
```bash
mount -t cifs //$target/$dir /mnt/smbmount -o username=$user,password=$pass,domain=WORKGROUP,rw
```

### SMB CheatSheet

```bash
smb: \> dir
smb: \> put test.txt
```


#### Alternative Data Streams

Check alternative data streams with `allinfo`:

```sh
smb: \> allinfo file.txt
stream: [:Password:$DATA], 15 bytes
```

Get file with alternative data stream `Password`:

```sh
get file.txt:Password
```